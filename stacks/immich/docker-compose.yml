services:
  # -----------------------------
  # Immich (Application Services)
  # -----------------------------

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    command: ["start.sh", "server"]
    restart: unless-stopped
    depends_on:
      - redis
      - database
    env_file:
      - .env
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Expose ONLY to localhost so Caddy can reverse proxy it securely.
    ports:
      - "127.0.0.1:2283:2283"

    volumes:
      - ./library:/usr/src/app/upload
    devices:
      - /dev/dri:/dev/dri
    environment:
      - LIBVA_DRIVER_NAME=r600
    group_add:
      - "44"   # video
      - "105"  # render
    networks:
      - proxy
      - immich

  immich-microservices:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-microservices
    command: ["start.sh", "microservices"]
    restart: unless-stopped
    depends_on:
      - redis
      - database
    env_file:
      - .env
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ./library:/usr/src/app/upload
    devices:
      - /dev/dri:/dev/dri
    environment:
      - LIBVA_DRIVER_NAME=r600
    group_add:
      - "44"   # video
      - "105"  # render
    networks:
      - immich

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ./model-cache:/cache
    networks:
      - immich

  # -----------------------------
  # Immich Dependencies
  # -----------------------------

  redis:
    image: redis:6
    container_name: immich-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - immich

  database:
    image: pgvector/pgvector:pg14
    container_name: immich-postgres
    restart: unless-stopped
    env_file:
      - .env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - immich

volumes:
  pgdata:

networks:
  # Reverse proxy network (external). Must exist already.
  proxy:
    external: true

  # Internal app network
  immich:
    driver: bridge
